# 🦞 奇门遁甲功能开发文档

## 📊 项目概述

奇门遁甲功能是基于现有"科学算命"系统的扩展，提供针对特定时间、地点、事件的决策支持功能。

- **核心价值**：从"知命"（八字看一生）扩展到"行事"（奇门做决策）
- **技术架构**：Next.js 14 + TypeScript + Vercel
- **开发周期**：4周（按计划推进）

---

## ✅ 已完成功能（第一阶段 - 第三阶段）

### 🎯 第一阶段：算法验证与后端构建

#### 1.1 奇门遁甲核心算法 ✅
- **文件**: `lib/qimen-core.ts`
  - 九宫八卦配置
  - 九星、八门、八神属性
  - 天干地支常量
  - 工具函数

#### 1.2 排盘算法 ✅
- **文件**: `lib/qimen-pai.ts`
  - 局数计算
  - 阴遁/阳遁判断
  - 值符值使计算
  - 天盘、人盘、神盘排布

#### 1.3 规则引擎 ✅
- **文件**: `lib/qimen-rules-engine.ts`
  - 7大类规则库（求财、事业、感情、寻人寻物、出行、健康、官司）
  - 规则匹配逻辑
  - 用神计算

#### 1.4 评分算法 ✅
- **文件**: `lib/qimen-score.ts`
  - 九星、八门、八神评分
  - 宫格综合评分
  - 最佳方位和时辰推荐

#### 1.5 文案生成 ✅
- **文件**: `lib/qimen-text-generator.ts`
  - 时机、自身、环境分析
  - 行动指南生成
  - 警告信息生成

#### 1.6 后端API ✅
- **文件**: `app/api/qimen/pai/route.ts`
  - 排盘接口
- **文件**: `app/api/qimen/analyze/route.ts`
  - 完整分析接口

### 🎨 第二阶段：前端UI开发

#### 2.1 奇门输入页面 ✅
- **文件**: `app/qimen/page.tsx`
  - 事项分类选择（7大类）
  - 具体问题输入
  - 起盘时间选择

#### 2.2 奇门结果页面 ✅
- **文件**: `app/qimen/result/page.tsx`
  - 顶部结论卡片
  - 九宫格可视化展示
  - 详细解读
  - 术语解释交互

#### 2.3 主页更新 ✅
- **文件**: `app/page.tsx`
  - 添加奇门遁甲入口
  - 奇门遁甲简介

---

## 🧪 测试验证

运行测试脚本验证功能：

```bash
cd /root/clawd/horoscope
node test-qimen.js
```

---

## 📁 文件结构

```
horoscope/
├── app/
│   ├── qimen/                          # 奇门遁甲前端页面
│   │   ├── page.tsx                    # 输入页面
│   │   └── result/
│   │       └── page.tsx                # 结果页面
│   ├── api/
│   │   └── qimen/                      # 奇门API
│   │       ├── pai/route.ts            # 排盘接口
│   │       └── analyze/route.ts        # 分析接口
│   └── page.tsx                        # 主页（已更新）
├── lib/
│   ├── qimen-core.ts                   # 核心常量和工具
│   ├── qimen-pai.ts                    # 排盘算法
│   ├── qimen-rules-engine.ts          # 规则引擎
│   ├── qimen-score.ts                  # 评分算法
│   └── qimen-text-generator.ts        # 文案生成
├── types/
│   └── qimen.ts                        # 类型定义
└── test-qimen.js                       # 测试脚本
```

---

## 🎯 功能特性

### 输入模块
- ✅ 事项分类选择（求财/事业/感情/寻人寻物/出行/健康/官司）
- ✅ 具体问题输入
- ✅ 起盘时间选择（默认当前时间，支持手动调整）

### 可视化展示
- ✅ 九宫格布局（3x3）
- ✅ 四层信息叠加（地盘、天盘、人盘、神盘）
- ✅ 值符值使高亮显示
- ✅ 术语解释交互（点击任意字符弹出解释）

### 分析结果
- ✅ 综合评分（-100到100分）
- ✅ 运势等级（大吉/吉/平/凶/大凶）
- ✅ 核心建议
- ✅ 策略推荐
- ✅ 最佳方位和时辰
- ✅ 详细解读（时机、自身、环境、行动）
- ✅ 警告信息

---

## 🚀 使用说明

### 开发环境运行

```bash
cd /root/clawd/horoscope
npm install
npm run dev
```

访问：http://localhost:3000/qimen

### 生产环境部署

```bash
npm run build
npm run start
```

或部署到Vercel：
```bash
vercel
```

---

## 📊 API接口

### 排盘接口
```
GET /api/qimen/pai?year=2024&month=2&day=7&hour=14
```

返回：完整奇门盘面数据

### 分析接口
```
GET /api/qimen/analyze?year=2024&month=2&day=7&hour=14&category=wealth&question=xxx
```

返回：完整分析结果（评分、建议、解读等）

---

## ⚠️ 注意事项

1. **算法简化**：当前实现为简化版本，适用于基础功能展示
2. **验证不足**：需要更多经典案例验证排盘准确性
3. **规则完善**：规则库可以持续扩展和完善
4. **免责声明**：需在显眼位置添加"仅供娱乐，切勿迷信"

---

## 🎯 后续优化方向

1. **算法优化**
   - 完善节气计算
   - 实现超神接气
   - 验证1080局排盘逻辑

2. **规则扩展**
   - 增加更多细分场景
   - 优化规则权重
   - 添加历史案例验证

3. **UI优化**
   - 添加动画效果
   - 优化移动端体验
   - 添加图表可视化

4. **功能增强**
   - 历史记录功能
   - 导出分享功能
   - (可选) OpenAI集成生成更人性化的解读

---

## 📝 更新日志

### 2026-02-08
- ✅ 完成核心算法开发
- ✅ 完成后端API开发
- ✅ 完成前端页面开发
- ✅ 完成主页集成
- ✅ 创建测试脚本

---

## 🙏 致谢

感谢传统周易数理文化的传承，本系统仅供学习和文化交流参考。
